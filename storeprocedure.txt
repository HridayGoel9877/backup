CREATE OR REPLACE PROCEDURE `mystical-slate-448109-u0.data_explore.create_bronze_table_can3bs6`()
BEGIN
    CREATE TABLE IF NOT EXISTS `mystical-slate-448109-u0.data_explore.CAN3BS6_BRONZE` (
        packetName STRING,
        deviceName STRING,
        errorFlag STRING,
        sdpArrivalTime TIMESTAMP,
        stage1ProcessingTime TIMESTAMP,
        stage2ProcessingTime TIMESTAMP,
        stage3ProcessingTime TIMESTAMP,
        dwIngestionTime TIMESTAMP,
        createdDate TIMESTAMP,
        updatedDate TIMESTAMP,
        schemaVersion STRING,
        eDate DATE,
        eDateTime TIMESTAMP,
        deviceId STRING,
        sequenceNumber STRING,
        latitude FLOAT64,
        longitude FLOAT64,
        utc INT64,
        reverseGear INT64,
        engineCoolantLevel FLOAT64,
        distanceInPowerMode FLOAT64,
        fuelInPowerMode FLOAT64,
        distanceInEcoMode FLOAT64,
        fuelInEcoMode FLOAT64,
        distanceInEcoPlusMode FLOAT64,
        fuelInEcoPlusMode FLOAT64,
        distanceInSweetSpotAcheived FLOAT64,
        fuelInSweetSpotAcheived FLOAT64,
        distanceInCruiseMode FLOAT64,
        fuelInCruiseMode FLOAT64,
        timeInPowerMode FLOAT64,
        timeInEcoMode FLOAT64,
        timeInEcoPlusMode FLOAT64,
        timeInSweetSpotAcheivedMode FLOAT64,
        timeInCruiseMode FLOAT64,
        multiModeSwitchStatus INT64,
        engineTotalIdleFuelUsed FLOAT64,
        engineTotalTimeIdleHours FLOAT64,
        appliedVehicleSpeedLimit INT64,
        aftertreatement1DieselExhaustFluidAverageConsumption FLOAT64,
        aftertreatement1CommandedDieselExhaustFluidConsumption FLOAT64,
        aftertreatement1ScrConversionEfficiency FLOAT64,
        aftertreatement1ScrOperatorInducmentActiveTravelled FLOAT64,
        ptoGovernorState INT64,
        primaryBrakePressure INT64,
        secondaryBrakePressure INT64,
        engineOilLevel FLOAT64,
        ptoTime INT64,
        ptoFuel FLOAT64,
        fuelInTopGear FLOAT64,
        timeInTopGear FLOAT64,
        distanceInTopGear FLOAT64,
        distanceInCoastingMode INT64,
        timeInCoastingMode INT64,
        brakeCounts INT64,
        stopCounts INT64,
        mainLogDriveFuel FLOAT64,
        mainLogDriveTime FLOAT64,
        mainLogPedalDistance FLOAT64,
        mainLogPedalFuel FLOAT64,
        mainLogPedalTime FLOAT64,
        adBlueConsumptionInRunningMode FLOAT64,
        adBlueConsumptionInStopMode FLOAT64,
        engineOilTemperature FLOAT64,
        strafingWarning INT64,
        drowsinessWarningStatusLevel1 INT64,
        drowsinessWarningStatusLevel2 INT64,
        drowsinessWarningStatusLevel3 INT64,
        strafingWarningCountOnTime INT64,
        drowsinessWarningStatusLevel1CountOnTime INT64,
        drowsinessWarningStatusLevel2CountOnTime INT64,
        drowsinessWarningStatusLevel3CountOnTime INT64,
        strafingWarningTotalCount INT64,
        drowsinessWarningStatusLevel1TotalCount INT64,
        drowsinessWarningStatusLevel2TotalCount INT64,
        drowsinessWarningStatusLevel3TotalCount INT64,
        engineTorqueMode INT64,
        liftAxelOnOff INT64,
        emsVersionToQuery STRING,
        live INT64,
        ignitionStatus INT64,
        cvssArmStatus INT64,
        cvssTriggerS2 INT64,
        cvssTrigLocation INT64
    );
    

    MERGE INTO `mystical-slate-448109-u0.data_explore.CAN3BS6_BRONZE` AS target
    USING (
        WITH CTE2 AS (
            SELECT *,
                   ROW_NUMBER() OVER(PARTITION BY deviceId, eDateTime) as row
            FROM `mystical-slate-448109-u0.data_explore.CAN3BS6_bigquery`
        )
        SELECT
            packetName, deviceName, errorFlag, sdpArrivalTime, stage1ProcessingTime, 
            stage2ProcessingTime, stage3ProcessingTime, dwIngestionTime, createdDate, 
            updatedDate, schemaVersion, eDate, eDateTime,
            CAST(deviceId AS STRING) AS deviceId,
            CAST(sequenceNumber AS STRING) AS sequenceNumber,
            CAST(latitude AS FLOAT64) AS latitude,
            CAST(longitude AS FLOAT64) AS longitude,
            CAST(utc AS INT64) AS utc,
            CAST(reverseGear AS INT64) AS reverseGear,
            CAST(engineCoolantLevel AS FLOAT64) AS engineCoolantLevel,
            CAST(distanceInPowerMode AS FLOAT64) AS distanceInPowerMode,
            CAST(fuelInPowerMode AS FLOAT64) AS fuelInPowerMode,
            CAST(distanceInEcoMode AS FLOAT64) AS distanceInEcoMode,
            CAST(fuelInEcoMode AS FLOAT64) AS fuelInEcoMode,
            CAST(distanceInEcoPlusMode AS FLOAT64) AS distanceInEcoPlusMode,
            CAST(fuelInEcoPlusMode AS FLOAT64) AS fuelInEcoPlusMode,
            CAST(distanceInSweetSpotAcheived AS FLOAT64) AS distanceInSweetSpotAcheived,
            CAST(fuelInSweetSpotAcheived AS FLOAT64) AS fuelInSweetSpotAcheived,
            CAST(distanceInCruiseMode AS FLOAT64) AS distanceInCruiseMode,
            CAST(fuelInCruiseMode AS FLOAT64) AS fuelInCruiseMode,
            CAST(timeInPowerMode AS FLOAT64) AS timeInPowerMode,
            CAST(timeInEcoMode AS FLOAT64) AS timeInEcoMode,
            CAST(timeInEcoPlusMode AS FLOAT64) AS timeInEcoPlusMode,
            CAST(timeInSweetSpotAcheivedMode AS FLOAT64) AS timeInSweetSpotAcheivedMode,
            CAST(timeInCruiseMode AS FLOAT64) AS timeInCruiseMode,
            CAST(multiModeSwitchStatus AS INT64) AS multiModeSwitchStatus,
            CAST(engineTotalIdleFuelUsed AS FLOAT64) AS engineTotalIdleFuelUsed,
            CAST(engineTotalTimeIdleHours AS FLOAT64) AS engineTotalTimeIdleHours,
            CAST(appliedVehicleSpeedLimit AS INT64) AS appliedVehicleSpeedLimit,
            CAST(aftertreatement1DieselExhaustFluidAverageConsumption AS FLOAT64) AS aftertreatement1DieselExhaustFluidAverageConsumption,
            CAST(aftertreatement1CommandedDieselExhaustFluidConsumption AS FLOAT64) AS aftertreatement1CommandedDieselExhaustFluidConsumption,
            CAST(aftertreatement1ScrConversionEfficiency AS FLOAT64) AS aftertreatement1ScrConversionEfficiency,
            CAST(aftertreatement1ScrOperatorInducmentActiveTravelled AS FLOAT64) AS aftertreatement1ScrOperatorInducmentActiveTravelled,
            CAST(ptoGovernorState AS INT64) AS ptoGovernorState,
            CAST(primaryBrakePressure AS INT64) AS primaryBrakePressure,
            CAST(secondaryBrakePressure AS INT64) AS secondaryBrakePressure,
            CAST(engineOilLevel AS FLOAT64) AS engineOilLevel,
            CAST(ptoTime AS INT64) AS ptoTime,
            CAST(ptoFuel AS FLOAT64) AS ptoFuel,
            CAST(fuelInTopGear AS FLOAT64) AS fuelInTopGear,
            CAST(timeInTopGear AS FLOAT64) AS timeInTopGear,
            CAST(distanceInTopGear AS FLOAT64) AS distanceInTopGear,
            CAST(distanceInCoastingMode AS INT64) AS distanceInCoastingMode,
            CAST(timeInCoastingMode AS INT64) AS timeInCoastingMode,
            CAST(brakeCounts AS INT64) AS brakeCounts,
            CAST(stopCounts AS INT64) AS stopCounts,
            CAST(mainLogDriveFuel AS FLOAT64) AS mainLogDriveFuel,
            CAST(mainLogDriveTime AS FLOAT64) AS mainLogDriveTime,
            CAST(mainLogPedalDistance AS FLOAT64) AS mainLogPedalDistance,
            CAST(mainLogPedalFuel AS FLOAT64) AS mainLogPedalFuel,
            CAST(mainLogPedalTime AS FLOAT64) AS mainLogPedalTime,
            CAST(adBlueConsumptionInRunningMode AS FLOAT64) AS adBlueConsumptionInRunningMode,
            CAST(adBlueConsumptionInStopMode AS FLOAT64) AS adBlueConsumptionInStopMode,
            CAST(engineOilTemperature AS FLOAT64) AS engineOilTemperature,
            CAST(strafingWarning AS INT64) AS strafingWarning,
            CAST(drowsinessWarningStatusLevel1 AS INT64) AS drowsinessWarningStatusLevel1,
            CAST(drowsinessWarningStatusLevel2 AS INT64) AS drowsinessWarningStatusLevel2,
            CAST(drowsinessWarningStatusLevel3 AS INT64) AS drowsinessWarningStatusLevel3,
            CAST(strafingWarningCountOnTime AS INT64) AS strafingWarningCountOnTime,
            CAST(drowsinessWarningStatusLevel1CountOnTime AS INT64) AS drowsinessWarningStatusLevel1CountOnTime,
            CAST(drowsinessWarningStatusLevel2CountOnTime AS INT64) AS drowsinessWarningStatusLevel2CountOnTime,
            CAST(drowsinessWarningStatusLevel3CountOnTime AS INT64) AS drowsinessWarningStatusLevel3CountOnTime,
            CAST(strafingWarningTotalCount AS INT64) AS strafingWarningTotalCount,
            CAST(drowsinessWarningStatusLevel1TotalCount AS INT64) AS drowsinessWarningStatusLevel1TotalCount,
            CAST(drowsinessWarningStatusLevel2TotalCount AS INT64) AS drowsinessWarningStatusLevel2TotalCount,
            CAST(drowsinessWarningStatusLevel3TotalCount AS INT64) AS drowsinessWarningStatusLevel3TotalCount,
            CAST(engineTorqueMode AS INT64) AS engineTorqueMode,
            CAST(liftAxelOnOff AS INT64) AS liftAxelOnOff,
            CAST(emsVersionToQuery AS STRING) AS emsVersionToQuery,
            CAST(live AS INT64) AS live,
            CAST(ignitionStatus AS INT64) AS ignitionStatus,
            CAST(cvssArmStatus AS INT64) AS cvssArmStatus,
            CAST(cvssTriggerS2 AS INT64) AS cvssTriggerS2,
            CAST(cvssTrigLocation AS INT64) AS cvssTrigLocation
        FROM CTE2
        WHERE row = 1
    ) AS source
    ON target.deviceId = source.deviceId AND target.eDateTime = source.eDateTime
    WHEN MATCHED THEN
        UPDATE SET
            target.packetName = source.packetName,
            target.deviceName = source.deviceName,
            target.errorFlag = source.errorFlag,
            target.sdpArrivalTime = source.sdpArrivalTime,
            target.stage1ProcessingTime = source.stage1ProcessingTime,
            target.stage2ProcessingTime = source.stage2ProcessingTime,
            target.stage3ProcessingTime = source.stage3ProcessingTime,
            target.dwIngestionTime = source.dwIngestionTime,
            target.createdDate = source.createdDate,
            target.updatedDate = source.updatedDate,
            target.schemaVersion = source.schemaVersion,
            target.eDate = source.eDate,
            target.sequenceNumber = source.sequenceNumber,
            target.latitude = source.latitude,
            target.longitude = source.longitude,
            target.utc = source.utc,
            target.reverseGear = source.reverseGear,
            target.engineCoolantLevel = source.engineCoolantLevel,
            target.distanceInPowerMode = source.distanceInPowerMode,
            target.fuelInPowerMode = source.fuelInPowerMode,
            target.distanceInEcoMode = source.distanceInEcoMode,
            target.fuelInEcoMode = source.fuelInEcoMode,
            target.distanceInEcoPlusMode = source.distanceInEcoPlusMode,
            target.fuelInEcoPlusMode = source.fuelInEcoPlusMode,
            target.distanceInSweetSpotAcheived = source.distanceInSweetSpotAcheived,
            target.fuelInSweetSpotAcheived = source.fuelInSweetSpotAcheived,
            target.distanceInCruiseMode = source.distanceInCruiseMode,
            target.fuelInCruiseMode = source.fuelInCruiseMode,
            target.timeInPowerMode = source.timeInPowerMode,
            target.timeInEcoMode = source.timeInEcoMode,
            target.timeInEcoPlusMode = source.timeInEcoPlusMode,
            target.timeInSweetSpotAcheivedMode = source.timeInSweetSpotAcheivedMode,
            target.timeInCruiseMode = source.timeInCruiseMode,
            target.multiModeSwitchStatus = source.multiModeSwitchStatus,
            target.engineTotalIdleFuelUsed = source.engineTotalIdleFuelUsed,
            target.engineTotalTimeIdleHours = source.engineTotalTimeIdleHours,
            target.appliedVehicleSpeedLimit = source.appliedVehicleSpeedLimit,
            target.aftertreatement1DieselExhaustFluidAverageConsumption = source.aftertreatement1DieselExhaustFluidAverageConsumption,
            target.aftertreatement1CommandedDieselExhaustFluidConsumption = source.aftertreatement1CommandedDieselExhaustFluidConsumption,
            target.aftertreatement1ScrConversionEfficiency = source.aftertreatement1ScrConversionEfficiency,
            target.aftertreatement1ScrOperatorInducmentActiveTravelled = source.aftertreatement1ScrOperatorInducmentActiveTravelled,
            target.ptoGovernorState = source.ptoGovernorState,
            target.primaryBrakePressure = source.primaryBrakePressure,
            target.secondaryBrakePressure = source.secondaryBrakePressure,
            target.engineOilLevel = source.engineOilLevel,
            target.ptoTime = source.ptoTime,
            target.ptoFuel = source.ptoFuel,
            target.fuelInTopGear = source.fuelInTopGear,
            target.timeInTopGear = source.timeInTopGear,
            target.distanceInTopGear = source.distanceInTopGear,
            target.distanceInCoastingMode = source.distanceInCoastingMode,
            target.timeInCoastingMode = source.timeInCoastingMode,
            target.brakeCounts = source.brakeCounts,
            target.stopCounts = source.stopCounts,
            target.mainLogDriveFuel = source.mainLogDriveFuel,
            target.mainLogDriveTime = source.mainLogDriveTime,
            target.mainLogPedalDistance = source.mainLogPedalDistance,
            target.mainLogPedalFuel = source.mainLogPedalFuel,
            target.mainLogPedalTime = source.mainLogPedalTime,
            target.adBlueConsumptionInRunningMode = source.adBlueConsumptionInRunningMode,
            target.adBlueConsumptionInStopMode = source.adBlueConsumptionInStopMode,
            target.engineOilTemperature = source.engineOilTemperature,
            target.strafingWarning = source.strafingWarning,
            target.drowsinessWarningStatusLevel1 = source.drowsinessWarningStatusLevel1,
            target.drowsinessWarningStatusLevel2 = source.drowsinessWarningStatusLevel2,
            target.drowsinessWarningStatusLevel3 = source.drowsinessWarningStatusLevel3,
            target.strafingWarningCountOnTime = source.strafingWarningCountOnTime,
            target.drowsinessWarningStatusLevel1CountOnTime = source.drowsinessWarningStatusLevel1CountOnTime,
            target.drowsinessWarningStatusLevel2CountOnTime = source.drowsinessWarningStatusLevel2CountOnTime,
            target.drowsinessWarningStatusLevel3CountOnTime = source.drowsinessWarningStatusLevel3CountOnTime,
            target.strafingWarningTotalCount = source.strafingWarningTotalCount,
            target.drowsinessWarningStatusLevel1TotalCount = source.drowsinessWarningStatusLevel1TotalCount,
            target.drowsinessWarningStatusLevel2TotalCount = source.drowsinessWarningStatusLevel2TotalCount,
            target.drowsinessWarningStatusLevel3TotalCount = source.drowsinessWarningStatusLevel3TotalCount,
            target.engineTorqueMode = source.engineTorqueMode,
            target.liftAxelOnOff = source.liftAxelOnOff,
            target.emsVersionToQuery = source.emsVersionToQuery,
            target.live = source.live,
            target.ignitionStatus = source.ignitionStatus,
            target.cvssArmStatus = source.cvssArmStatus,
            target.cvssTriggerS2 = source.cvssTriggerS2,
            target.cvssTrigLocation = source.cvssTrigLocation
    WHEN NOT MATCHED THEN
        INSERT ROW;
END;


CREATE OR REPLACE PROCEDURE `mystical-slate-448109-u0.data_explore.create_bronze_table_can2bs6`()
BEGIN
    CREATE TABLE IF NOT EXISTS `mystical-slate-448109-u0.data_explore.CAN2BS6_BRONZE` (
        packetName STRING,
        deviceName STRING,
        errorFlag STRING,
        sdpArrivalTime TIMESTAMP,
        stage1ProcessingTime TIMESTAMP,
        stage2ProcessingTime TIMESTAMP,
        stage3ProcessingTime TIMESTAMP,
        dwIngestionTime TIMESTAMP,
        createdDate TIMESTAMP,
        updatedDate TIMESTAMP,
        schemaVersion STRING,
        eDate DATE,
        eDateTime TIMESTAMP,
        deviceId STRING,
        sequenceNumber STRING,
        latitude FLOAT64,
        longitude FLOAT64,
        utc INT64,
        dieselParticulateFilterLampCmd INT64,
        dslPrtcltFltrPssvRgnrtionStatus INT64,
        dslPrtcltFltrActvRgnrtionStatus INT64,
        dslPrtcltFltrsttus INT64,
        dslPrtcltFltrActvRgnrtnInhbtdStts INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTInhbtSwtch INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTCltchDsnggd INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTSrvcBrkActv INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTPTOActv INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTAcclPdlOffIdl INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTOtOfNtrl INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTVhclSpdAbvAllwd INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTPrkngBrkNtSt INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTLwExhstGsTmp INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTSystmFltActv INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTSystmTmt INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTTmprrySystmLckt INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTPrmnntSystmLckt INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTEngNtWrmdUp INT64,
        dslPrtcltFltrActvRgnrtnInhbtdDTVhclSpdBlwAllwd INT64,
        dslPrtcltFltrAtmtcActvRgnrtnInttnCnfg INT64,
        exhaustSystemHighTempLampCmd INT64,
        dslPrtcltFltrActvRgnrtnFrcdStts INT64,
        particulateTrap1SootLoadPercent FLOAT64,
        particulateTrap1AshLoadPercent FLOAT64,
        prtcltTrp1TmSncLstActvRgnration INT64,
        afterTreatmentTemperature INT64,
        afterTreatmentfluidlevel FLOAT64,
        aftertreatment1DieselExhaustFluidConcentration FLOAT64,
        dslOxicatIntkGastmp FLOAT64,
        dslOxicatOutkGastmp FLOAT64,
        catlistUpstrmTmp FLOAT64,
        engExhustGasValveCntrl FLOAT64,
        engVariblTurboCharg FLOAT64,
        dpsPraticultePressure FLOAT64,
        inletNoxConcentration FLOAT64,
        outletNoxConcentration FLOAT64,
        waterInFuelIndicator INT64,
        ambientBarometricPressure FLOAT64,
        ambientTemperature FLOAT64,
        intakeAirTemperature FLOAT64,
        fanState INT64,
        fanSpeed FLOAT64,
        enbRKAsstSW INT64,
        intakeManifoldPressure INT64,
        intakemanifoldtemp INT64,
        engCoolantLevel FLOAT64,
        accPedalPedal FLOAT64,
        actualEnginePercentTorque INT64,
        engineDemandPercentTorque INT64,
        transmissionCurrentGear INT64,
        transMode1Indicator INT64,
        transMode2Indicator INT64,
        transMode3Indicator INT64,
        afterTreatmentTankLevel FLOAT64,
        brakeApplicationPressure INT64,
        tireloc INT64,
        tireprssr INT64,
        tiretemp FLOAT64,
        straffingWarning INT64,
        drowsinessWarningStatusLevel1 INT64,
        Drowsinesswarningstatuslevel2 INT64,
        drowsinessWarningStatusLevel3 INT64,
        cameraError INT64,
        videoRecordingError INT64,
        brakeSwitch FLOAT64,
        clutchSwitch FLOAT64,
        clutchOnTime FLOAT64,
        clutchCount INT64,
        brakeOnTime FLOAT64,
        brakeCount INT64,
        cng FLOAT64,
        live INT64,
        ignitionStatus INT64
    );
    

    MERGE INTO `mystical-slate-448109-u0.data_explore.CAN2BS6_BRONZE` AS target
    USING (
        WITH CTE2 AS (
            SELECT *,
                   ROW_NUMBER() OVER(PARTITION BY deviceId, eDateTime) as row
            FROM `mystical-slate-448109-u0.data_explore.CAN2BS6_bigquery`
        )
        SELECT
            packetName, deviceName, errorFlag, sdpArrivalTime, stage1ProcessingTime, 
            stage2ProcessingTime, stage3ProcessingTime, dwIngestionTime, createdDate, 
            updatedDate, schemaVersion, eDate, eDateTime,
            CAST(deviceId AS STRING) AS deviceId,
            CAST(sequenceNumber AS STRING) AS sequenceNumber,
            CAST(latitude AS FLOAT64) AS latitude,
            CAST(longitude AS FLOAT64) AS longitude,
            CAST(utc AS INT64) AS utc,
            CAST(dieselParticulateFilterLampCmd AS INT64) AS dieselParticulateFilterLampCmd,
            CAST(dslPrtcltFltrPssvRgnrtionStatus AS INT64) AS dslPrtcltFltrPssvRgnrtionStatus,
            CAST(dslPrtcltFltrActvRgnrtionStatus AS INT64) AS dslPrtcltFltrActvRgnrtionStatus,
            CAST(dslPrtcltFltrsttus AS INT64) AS dslPrtcltFltrsttus,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdStts AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdStts,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTInhbtSwtch AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTInhbtSwtch,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTCltchDsnggd AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTCltchDsnggd,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTSrvcBrkActv AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTSrvcBrkActv,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTPTOActv AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTPTOActv,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTAcclPdlOffIdl AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTAcclPdlOffIdl,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTOtOfNtrl AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTOtOfNtrl,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTVhclSpdAbvAllwd AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTVhclSpdAbvAllwd,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTPrkngBrkNtSt AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTPrkngBrkNtSt,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTLwExhstGsTmp AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTLwExhstGsTmp,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTSystmFltActv AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTSystmFltActv,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTSystmTmt AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTSystmTmt,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTTmprrySystmLckt AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTTmprrySystmLckt,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTPrmnntSystmLckt AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTPrmnntSystmLckt,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTEngNtWrmdUp AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTEngNtWrmdUp,
            CAST(dslPrtcltFltrActvRgnrtnInhbtdDTVhclSpdBlwAllwd AS INT64) AS dslPrtcltFltrActvRgnrtnInhbtdDTVhclSpdBlwAllwd,
            CAST(dslPrtcltFltrAtmtcActvRgnrtnInttnCnfg AS INT64) AS dslPrtcltFltrAtmtcActvRgnrtnInttnCnfg,
            CAST(exhaustSystemHighTempLampCmd AS INT64) AS exhaustSystemHighTempLampCmd,
            CAST(dslPrtcltFltrActvRgnrtnFrcdStts AS INT64) AS dslPrtcltFltrActvRgnrtnFrcdStts,
            CAST(particulateTrap1SootLoadPercent AS FLOAT64) AS particulateTrap1SootLoadPercent,
            CAST(particulateTrap1AshLoadPercent AS FLOAT64) AS particulateTrap1AshLoadPercent,
            CAST(prtcltTrp1TmSncLstActvRgnration AS INT64) AS prtcltTrp1TmSncLstActvRgnration,
            CAST(afterTreatmentTemperature AS INT64) AS afterTreatmentTemperature,
            CAST(afterTreatmentfluidlevel AS FLOAT64) AS afterTreatmentfluidlevel,
            CAST(aftertreatment1DieselExhaustFluidConcentration AS FLOAT64) AS aftertreatment1DieselExhaustFluidConcentration,
            CAST(dslOxicatIntkGastmp AS FLOAT64) AS dslOxicatIntkGastmp,
            CAST(dslOxicatOutkGastmp AS FLOAT64) AS dslOxicatOutkGastmp,
            CAST(catlistUpstrmTmp AS FLOAT64) AS catlistUpstrmTmp,
            CAST(engExhustGasValveCntrl AS FLOAT64) AS engExhustGasValveCntrl,
            CAST(engVariblTurboCharg AS FLOAT64) AS engVariblTurboCharg,
            CAST(dpsPraticultePressure AS FLOAT64) AS dpsPraticultePressure,
            CAST(inletNoxConcentration AS FLOAT64) AS inletNoxConcentration,
            CAST(outletNoxConcentration AS FLOAT64) AS outletNoxConcentration,
            CAST(waterInFuelIndicator AS INT64) AS waterInFuelIndicator,
            CAST(ambientBarometricPressure AS FLOAT64) AS ambientBarometricPressure,
            CAST(ambientTemperature AS FLOAT64) AS ambientTemperature,
            CAST(intakeAirTemperature AS FLOAT64) AS intakeAirTemperature,
            CAST(fanState AS INT64) AS fanState,
            CAST(fanSpeed AS FLOAT64) AS fanSpeed,
            CAST(enbRKAsstSW AS INT64) AS enbRKAsstSW,
            CAST(intakeManifoldPressure AS INT64) AS intakeManifoldPressure,
            CAST(intakemanifoldtemp AS INT64) AS intakemanifoldtemp,
            CAST(engCoolantLevel AS FLOAT64) AS engCoolantLevel,
            CAST(accPedalPedal AS FLOAT64) AS accPedalPedal,
            CAST(actualEnginePercentTorque AS INT64) AS actualEnginePercentTorque,
            CAST(engineDemandPercentTorque AS INT64) AS engineDemandPercentTorque,
            CAST(transmissionCurrentGear AS INT64) AS transmissionCurrentGear,
            CAST(transMode1Indicator AS INT64) AS transMode1Indicator,
            CAST(transMode2Indicator AS INT64) AS transMode2Indicator,
            CAST(transMode3Indicator AS INT64) AS transMode3Indicator,
            CAST(afterTreatmentTankLevel AS FLOAT64) AS afterTreatmentTankLevel,
            CAST(brakeApplicationPressure AS INT64) AS brakeApplicationPressure,
            CAST(tireloc AS INT64) AS tireloc,
            CAST(tireprssr AS INT64) AS tireprssr,
            CAST(tiretemp AS FLOAT64) AS tiretemp,
            CAST(straffingWarning AS INT64) AS straffingWarning,
            CAST(drowsinessWarningStatusLevel1 AS INT64) AS drowsinessWarningStatusLevel1,
            CAST(Drowsinesswarningstatuslevel2 AS INT64) AS Drowsinesswarningstatuslevel2,
            CAST(drowsinessWarningStatusLevel3 AS INT64) AS drowsinessWarningStatusLevel3,
            CAST(cameraError AS INT64) AS cameraError,
            CAST(videoRecordingError AS INT64) AS videoRecordingError,
            CAST(brakeSwitch AS FLOAT64) AS brakeSwitch,
            CAST(clutchSwitch AS FLOAT64) AS clutchSwitch,
            CAST(clutchOnTime AS FLOAT64) AS clutchOnTime,
            CAST(clutchCount AS INT64) AS clutchCount,
            CAST(brakeOnTime AS FLOAT64) AS brakeOnTime,
            CAST(brakeCount AS INT64) AS brakeCount,
            CAST(cng AS FLOAT64) AS cng,
            CAST(live AS INT64) AS live,
            CAST(ignitionStatus AS INT64) AS ignitionStatus
        FROM CTE2
        WHERE row = 1
    ) AS source
    ON target.deviceId = source.deviceId AND target.eDateTime = source.eDateTime
    WHEN MATCHED THEN
        UPDATE SET
            target.packetName = source.packetName,
            target.deviceName = source.deviceName,
            target.errorFlag = source.errorFlag,
            target.sdpArrivalTime = source.sdpArrivalTime,
            target.stage1ProcessingTime = source.stage1ProcessingTime,
            target.stage2ProcessingTime = source.stage2ProcessingTime,
            target.stage3ProcessingTime = source.stage3ProcessingTime,
            target.dwIngestionTime = source.dwIngestionTime,
            target.createdDate = source.createdDate,
            target.updatedDate = source.updatedDate,
            target.schemaVersion = source.schemaVersion,
            target.eDate = source.eDate,
            target.sequenceNumber = source.sequenceNumber,
            target.latitude = source.latitude,
            target.longitude = source.longitude,
            target.utc = source.utc,
            target.dieselParticulateFilterLampCmd = source.dieselParticulateFilterLampCmd,
            target.dslPrtcltFltrPssvRgnrtionStatus = source.dslPrtcltFltrPssvRgnrtionStatus,
            target.dslPrtcltFltrActvRgnrtionStatus = source.dslPrtcltFltrActvRgnrtionStatus,
            target.dslPrtcltFltrsttus = source.dslPrtcltFltrsttus,
            target.dslPrtcltFltrActvRgnrtnInhbtdStts = source.dslPrtcltFltrActvRgnrtnInhbtdStts,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTInhbtSwtch = source.dslPrtcltFltrActvRgnrtnInhbtdDTInhbtSwtch,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTCltchDsnggd = source.dslPrtcltFltrActvRgnrtnInhbtdDTCltchDsnggd,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTSrvcBrkActv = source.dslPrtcltFltrActvRgnrtnInhbtdDTSrvcBrkActv,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTPTOActv = source.dslPrtcltFltrActvRgnrtnInhbtdDTPTOActv,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTAcclPdlOffIdl = source.dslPrtcltFltrActvRgnrtnInhbtdDTAcclPdlOffIdl,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTOtOfNtrl = source.dslPrtcltFltrActvRgnrtnInhbtdDTOtOfNtrl,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTVhclSpdAbvAllwd = source.dslPrtcltFltrActvRgnrtnInhbtdDTVhclSpdAbvAllwd,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTPrkngBrkNtSt = source.dslPrtcltFltrActvRgnrtnInhbtdDTPrkngBrkNtSt,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTLwExhstGsTmp = source.dslPrtcltFltrActvRgnrtnInhbtdDTLwExhstGsTmp,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTSystmFltActv = source.dslPrtcltFltrActvRgnrtnInhbtdDTSystmFltActv,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTSystmTmt = source.dslPrtcltFltrActvRgnrtnInhbtdDTSystmTmt,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTTmprrySystmLckt = source.dslPrtcltFltrActvRgnrtnInhbtdDTTmprrySystmLckt,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTPrmnntSystmLckt = source.dslPrtcltFltrActvRgnrtnInhbtdDTPrmnntSystmLckt,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTEngNtWrmdUp = source.dslPrtcltFltrActvRgnrtnInhbtdDTEngNtWrmdUp,
            target.dslPrtcltFltrActvRgnrtnInhbtdDTVhclSpdBlwAllwd = source.dslPrtcltFltrActvRgnrtnInhbtdDTVhclSpdBlwAllwd,
            target.dslPrtcltFltrAtmtcActvRgnrtnInttnCnfg = source.dslPrtcltFltrAtmtcActvRgnrtnInttnCnfg,
            target.exhaustSystemHighTempLampCmd = source.exhaustSystemHighTempLampCmd,
            target.dslPrtcltFltrActvRgnrtnFrcdStts = source.dslPrtcltFltrActvRgnrtnFrcdStts,
            target.particulateTrap1SootLoadPercent = source.particulateTrap1SootLoadPercent,
            target.particulateTrap1AshLoadPercent = source.particulateTrap1AshLoadPercent,
            target.prtcltTrp1TmSncLstActvRgnration = source.prtcltTrp1TmSncLstActvRgnration,
            target.afterTreatmentTemperature = source.afterTreatmentTemperature,
            target.afterTreatmentfluidlevel = source.afterTreatmentfluidlevel,
            target.aftertreatment1DieselExhaustFluidConcentration = source.aftertreatment1DieselExhaustFluidConcentration,
            target.dslOxicatIntkGastmp = source.dslOxicatIntkGastmp,
            target.dslOxicatOutkGastmp = source.dslOxicatOutkGastmp,
            target.catlistUpstrmTmp = source.catlistUpstrmTmp,
            target.engExhustGasValveCntrl = source.engExhustGasValveCntrl,
            target.engVariblTurboCharg = source.engVariblTurboCharg,
            target.dpsPraticultePressure = source.dpsPraticultePressure,
            target.inletNoxConcentration = source.inletNoxConcentration,
            target.outletNoxConcentration = source.outletNoxConcentration,
            target.waterInFuelIndicator = source.waterInFuelIndicator,
            target.ambientBarometricPressure = source.ambientBarometricPressure,
            target.ambientTemperature = source.ambientTemperature,
            target.intakeAirTemperature = source.intakeAirTemperature,
            target.fanState = source.fanState,
            target.fanSpeed = source.fanSpeed,
            target.enbRKAsstSW = source.enbRKAsstSW,
            target.intakeManifoldPressure = source.intakeManifoldPressure,
            target.intakemanifoldtemp = source.intakemanifoldtemp,
            target.engCoolantLevel = source.engCoolantLevel,
            target.accPedalPedal = source.accPedalPedal,
            target.actualEnginePercentTorque = source.actualEnginePercentTorque,
            target.engineDemandPercentTorque = source.engineDemandPercentTorque,
            target.transmissionCurrentGear = source.transmissionCurrentGear,
            target.transMode1Indicator = source.transMode1Indicator,
            target.transMode2Indicator = source.transMode2Indicator,
            target.transMode3Indicator = source.transMode3Indicator,
            target.afterTreatmentTankLevel = source.afterTreatmentTankLevel,
            target.brakeApplicationPressure = source.brakeApplicationPressure,
            target.tireloc = source.tireloc,
            target.tireprssr = source.tireprssr,
            target.tiretemp = source.tiretemp,
            target.straffingWarning = source.straffingWarning,
            target.drowsinessWarningStatusLevel1 = source.drowsinessWarningStatusLevel1,
            target.Drowsinesswarningstatuslevel2 = source.Drowsinesswarningstatuslevel2,
            target.drowsinessWarningStatusLevel3 = source.drowsinessWarningStatusLevel3,
            target.cameraError = source.cameraError,
            target.videoRecordingError = source.videoRecordingError,
            target.brakeSwitch = source.brakeSwitch,
            target.clutchSwitch = source.clutchSwitch,
            target.clutchOnTime = source.clutchOnTime,
            target.clutchCount = source.clutchCount,
            target.brakeOnTime = source.brakeOnTime,
            target.brakeCount = source.brakeCount,
            target.cng = source.cng,
            target.live = source.live,
            target.ignitionStatus = source.ignitionStatus
    WHEN NOT MATCHED THEN
        INSERT ROW;
END;


CREATE OR REPLACE PROCEDURE `mystical-slate-448109-u0.data_explore.create_bronze_table_canbs4`()
BEGIN

    CREATE TABLE IF NOT EXISTS `mystical-slate-448109-u0.data_explore.CANBS4_BRONZE` (
        packetName STRING,
        deviceName STRING,
        errorFlag INT64,
        sdpArrivalTime TIMESTAMP,
        stage1ProcessingTime TIMESTAMP,
        stage2ProcessingTime TIMESTAMP,
        stage3ProcessingTime TIMESTAMP,
        dwIngestionTime TIMESTAMP,
        createdDate TIMESTAMP,
        updatedDate TIMESTAMP,
        schemaVersion STRING,
        eDate DATE,
        eDateTime TIMESTAMP,
        deviceId STRING,
        sequenceNumber STRING,
        latitude FLOAT64,
        longitude FLOAT64,
        utc INT64,
        hrlfc NUMERIC,
        sweetSpot INT64,
        topGear INT64,
        sweetSpotPerc INT64,
        seconds FLOAT64,
        minute INT64,
        hour FLOAT64,
        month FLOAT64,
        day FLOAT64,
        year INT64,
        minuteOffset INT64,
        hourOffset INT64,
        totalDistance FLOAT64,
        fuelLevel FLOAT64,
        amberWarningLamp INT64,
        redStopLamp INT64,
        malfuncLamp INT64,
        flashMalfuncLamp INT64,
        spnLsb INT64,
        spn82ndByte INT64,
        failureMode INT64,
        spn3Msb INT64,
        occurrenceCount INT64,
        cca INT64,
        cces INT64,
        ccss INT64,
        engineSpeed FLOAT64,
        engineStartMode INT64,
        engineOpHours FLOAT64,
        powerKeyPos INT64,
        accPedalDelSwitch INT64,
        vehicleSpeed FLOAT64,
        controllerTrimMode INT64,
        engineOilPressure INT64,
        engineCoolantTemp INT64,
        accPedalPosition FLOAT64,
        tripFuel FLOAT64,
        live INT64,
        ignitionStatus INT64
    );
    

    MERGE INTO `mystical-slate-448109-u0.data_explore.CANBS4_BRONZE` AS target
    USING (
        WITH CTE2 AS (
            SELECT *,
                   ROW_NUMBER() OVER(PARTITION BY deviceId, eDateTime) as row
            FROM `mystical-slate-448109-u0.data_explore.CANBS4_bigquery`
        )
        SELECT
            packetName, deviceName, errorFlag, sdpArrivalTime, stage1ProcessingTime, 
            stage2ProcessingTime, stage3ProcessingTime, dwIngestionTime, createdDate, 
            updatedDate, schemaVersion, eDate, eDateTime,
            CAST(deviceId AS STRING) AS deviceId,
            CAST(sequenceNumber AS STRING) AS sequenceNumber,
            CAST(latitude AS FLOAT64) AS latitude,
            CAST(longitude AS FLOAT64) AS longitude,
            CAST(utc AS INT64) AS utc,
            CAST(hrlfc AS NUMERIC) AS hrlfc,
            CAST(sweetSpot AS INT64) AS sweetSpot,
            CAST(topGear AS INT64) AS topGear,
            CAST(sweetSpotPerc AS INT64) AS sweetSpotPerc,
            CAST(seconds AS FLOAT64) AS seconds,
            CAST(minute AS INT64) AS minute,
            CAST(hour AS FLOAT64) AS hour,
            CAST(month AS FLOAT64) AS month,
            CAST(day AS FLOAT64) AS day,
            CAST(year AS INT64) AS year,
            CAST(minuteOffset AS INT64) AS minuteOffset,
            CAST(hourOffset AS INT64) AS hourOffset,
            CAST(totalDistance AS FLOAT64) AS totalDistance,
            CAST(fuelLevel AS FLOAT64) AS fuelLevel,
            CAST(amberWarningLamp AS INT64) AS amberWarningLamp,
            CAST(redStopLamp AS INT64) AS redStopLamp,
            CAST(malfuncLamp AS INT64) AS malfuncLamp,
            CAST(flashMalfuncLamp AS INT64) AS flashMalfuncLamp,
            CAST(spnLsb AS INT64) AS spnLsb,
            CAST(spn82ndByte AS INT64) AS spn82ndByte,
            CAST(failureMode AS INT64) AS failureMode,
            CAST(spn3Msb AS INT64) AS spn3Msb,
            CAST(occurrenceCount AS INT64) AS occurrenceCount,
            CAST(cca AS INT64) AS cca,
            CAST(cces AS INT64) AS cces,
            CAST(ccss AS INT64) AS ccss,
            CAST(engineSpeed AS FLOAT64) AS engineSpeed,
            CAST(engineStartMode AS INT64) AS engineStartMode,
            CAST(engineOpHours AS FLOAT64) AS engineOpHours,
            CAST(powerKeyPos AS INT64) AS powerKeyPos,
            CAST(accPedalDelSwitch AS INT64) AS accPedalDelSwitch,
            CAST(vehicleSpeed AS FLOAT64) AS vehicleSpeed,
            CAST(controllerTrimMode AS INT64) AS controllerTrimMode,
            CAST(engineOilPressure AS INT64) AS engineOilPressure,
            CAST(engineCoolantTemp AS INT64) AS engineCoolantTemp,
            CAST(accPedalPosition AS FLOAT64) AS accPedalPosition,
            CAST(tripFuel AS FLOAT64) AS tripFuel,
            CAST(live AS INT64) AS live,
            CAST(ignitionStatus AS INT64) AS ignitionStatus
        FROM CTE2
        WHERE row = 1
    ) AS source
    ON target.deviceId = source.deviceId AND target.eDateTime = source.eDateTime
    WHEN MATCHED THEN
        UPDATE SET
            target.packetName = source.packetName,
            target.deviceName = source.deviceName,
            target.errorFlag = source.errorFlag,
            target.sdpArrivalTime = source.sdpArrivalTime,
            target.stage1ProcessingTime = source.stage1ProcessingTime,
            target.stage2ProcessingTime = source.stage2ProcessingTime,
            target.stage3ProcessingTime = source.stage3ProcessingTime,
            target.dwIngestionTime = source.dwIngestionTime,
            target.createdDate = source.createdDate,
            target.updatedDate = source.updatedDate,
            target.schemaVersion = source.schemaVersion,
            target.eDate = source.eDate,
            target.sequenceNumber = source.sequenceNumber,
            target.latitude = source.latitude,
            target.longitude = source.longitude,
            target.utc = source.utc,
            target.hrlfc = source.hrlfc,
            target.sweetSpot = source.sweetSpot,
            target.topGear = source.topGear,
            target.sweetSpotPerc = source.sweetSpotPerc,
            target.seconds = source.seconds,
            target.minute = source.minute,
            target.hour = source.hour,
            target.month = source.month,
            target.day = source.day,
            target.year = source.year,
            target.minuteOffset = source.minuteOffset,
            target.hourOffset = source.hourOffset,
            target.totalDistance = source.totalDistance,
            target.fuelLevel = source.fuelLevel,
            target.amberWarningLamp = source.amberWarningLamp,
            target.redStopLamp = source.redStopLamp,
            target.malfuncLamp = source.malfuncLamp,
            target.flashMalfuncLamp = source.flashMalfuncLamp,
            target.spnLsb = source.spnLsb,
            target.spn82ndByte = source.spn82ndByte,
            target.failureMode = source.failureMode,
            target.spn3Msb = source.spn3Msb,
            target.occurrenceCount = source.occurrenceCount,
            target.cca = source.cca,
            target.cces = source.cces,
            target.ccss = source.ccss,
            target.engineSpeed = source.engineSpeed,
            target.engineStartMode = source.engineStartMode,
            target.engineOpHours = source.engineOpHours,
            target.powerKeyPos = source.powerKeyPos,
            target.accPedalDelSwitch = source.accPedalDelSwitch,
            target.vehicleSpeed = source.vehicleSpeed,
            target.controllerTrimMode = source.controllerTrimMode,
            target.engineOilPressure = source.engineOilPressure,
            target.engineCoolantTemp = source.engineCoolantTemp,
            target.accPedalPosition = source.accPedalPosition,
            target.tripFuel = source.tripFuel,
            target.live = source.live,
            target.ignitionStatus = source.ignitionStatus
    WHEN NOT MATCHED THEN
        INSERT ROW;
END;


CREATE OR REPLACE PROCEDURE `mystical-slate-448109-u0.data_explore.create_bronze_table_dtca`()
BEGIN

    CREATE TABLE IF NOT EXISTS `mystical-slate-448109-u0.data_explore.DTCA_BRONZE` (
        packetName STRING,
        deviceName STRING,
        errorFlag STRING,
        sdpArrivalTime TIMESTAMP,
        stage1ProcessingTime TIMESTAMP,
        stage2ProcessingTime TIMESTAMP,
        stage3ProcessingTime TIMESTAMP,
        dwIngestionTime TIMESTAMP,
        createdDate TIMESTAMP,
        updatedDate TIMESTAMP,
        schemaVersion STRING,
        eDate DATE,
        eDateTime TIMESTAMP,
        deviceId STRING,
        sequenceNumber STRING,
        latitude FLOAT64,
        longitude FLOAT64,
        utc INT64,
        numberOfFaultCodes INT64,
        faults ARRAY<STRUCT<
            spn INT64,
            fmi INT64,
            cm INT64,
            dtccode STRING,
            discription STRING,
            occuranceCount INT64
        >>,
        cDateTime TIMESTAMP,
        kinesisArrivalTime TIMESTAMP,
        messageType INT64,
        obd INT64
    );
    

    MERGE INTO `mystical-slate-448109-u0.data_explore.DTCA_BRONZE` AS target
    USING (
        WITH CTE2 AS (
            SELECT *,
                   ROW_NUMBER() OVER(PARTITION BY deviceId, eDateTime) as row
            FROM `mystical-slate-448109-u0.data_explore.DTCA_bigquery`
        )
        SELECT
            packetName, deviceName, errorFlag, sdpArrivalTime, stage1ProcessingTime, 
            stage2ProcessingTime, stage3ProcessingTime, dwIngestionTime, createdDate, 
            updatedDate, schemaVersion, eDate, eDateTime,
            CAST(deviceId AS STRING) AS deviceId,
            CAST(sequenceNumber AS STRING) AS sequenceNumber,
            CAST(latitude AS FLOAT64) AS latitude,
            CAST(longitude AS FLOAT64) AS longitude,
            CAST(utc AS INT64) AS utc,
            CAST(numberOfFaultCodes AS INT64) AS numberOfFaultCodes,
            ARRAY(
                SELECT AS STRUCT
                    CAST(JSON_EXTRACT_SCALAR(fault, '$.spn') AS INT64) AS spn,
                    CAST(JSON_EXTRACT_SCALAR(fault, '$.fmi') AS INT64) AS fmi,
                    CAST(JSON_EXTRACT_SCALAR(fault, '$.cm') AS INT64) AS cm,
                    CAST(JSON_EXTRACT_SCALAR(fault, '$.dtccode') AS STRING) AS dtccode,
                    CAST(JSON_EXTRACT_SCALAR(fault, '$.discription') AS STRING) AS discription,
                    CAST(JSON_EXTRACT_SCALAR(fault, '$.occuranceCount') AS INT64) AS occuranceCount
                FROM UNNEST(JSON_EXTRACT_ARRAY(faults)) AS fault
            ) AS faults,
            TIMESTAMP(PARSE_TIMESTAMP('%Y%m%d%H%M%S', cDateTime)) AS cDateTime,
            TIMESTAMP(PARSE_TIMESTAMP('%Y%m%d%H%M%S', kinesisArrivalTime)) AS kinesisArrivalTime,
            CAST(messageType AS INT64) AS messageType,
            CAST(obd AS INT64) AS obd
        FROM CTE2
        WHERE row = 1
    ) AS source
    ON target.deviceId = source.deviceId AND target.eDateTime = source.eDateTime
    WHEN MATCHED THEN
        UPDATE SET
            target.packetName = source.packetName,
            target.deviceName = source.deviceName,
            target.errorFlag = source.errorFlag,
            target.sdpArrivalTime = source.sdpArrivalTime,
            target.stage1ProcessingTime = source.stage1ProcessingTime,
            target.stage2ProcessingTime = source.stage2ProcessingTime,
            target.stage3ProcessingTime = source.stage3ProcessingTime,
            target.dwIngestionTime = source.dwIngestionTime,
            target.createdDate = source.createdDate,
            target.updatedDate = source.updatedDate,
            target.schemaVersion = source.schemaVersion,
            target.eDate = source.eDate,
            target.sequenceNumber = source.sequenceNumber,
            target.latitude = source.latitude,
            target.longitude = source.longitude,
            target.utc = source.utc,
            target.numberOfFaultCodes = source.numberOfFaultCodes,
            target.faults = source.faults,
            target.cDateTime = source.cDateTime,
            target.kinesisArrivalTime = source.kinesisArrivalTime,
            target.messageType = source.messageType,
            target.obd = source.obd
    WHEN NOT MATCHED THEN
        INSERT ROW;
END;